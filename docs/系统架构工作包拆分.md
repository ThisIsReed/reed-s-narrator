# 故事叙述者系统工作包拆分（基于系统架构设计）

## 1. 依据文档
- `docs/系统架构设计方案.md`
- `docs/初版UserStory-系统架构设计.md`
- `docs/综合评审意见.md`

## 2. 拆分原则
- 以“四层架构 + 物候独立模块 + 持久化与测试”进行纵向分包。
- 先保障阶段A最小闭环（可跑、可审计、可重放），再进入阶段B增强。
- 每个工作包必须有明确输入输出、依赖和验收口径。

## 3. 工作包总览

| 工作包ID | 名称 | 对应阶段 | 核心目标 | 关键依赖 |
|---|---|---|---|---|
| WP-01 | 项目基线与配置体系 | A | 建立可运行骨架与统一配置 | 无 |
| WP-02 | 领域模型与契约定义 | A | 固化核心数据结构与枚举 | WP-01 |
| WP-03 | Simulation Core 确定性内核 | A | 实现 Tick、规则结算、中断、Seed 管理 | WP-02 |
| WP-04 | 持久化与可恢复能力 | A | SQLite、仓储、快照、checkpoint | WP-02, WP-03 |
| WP-05 | 物候系统（硬约束） | A | 物候日历与数值约束生效 | WP-02, WP-03 |
| WP-06 | LLM 抽象与多 Provider 路由 | A | 统一 LLM 接口与结构化输出 | WP-02 |
| WP-07 | Knowledge & Diffusion 基础层 | A | 客观事实/主观认知与可见性隔离 | WP-02, WP-04 |
| WP-08 | Agent 层（意图/DM/重试） | A | 角色意图生成、校验、无状态结算 | WP-02, WP-06, WP-07 |
| WP-09 | Orchestrator 主循环组装层 | A | 串联全流程并形成演化闭环 | WP-03~WP-08 |
| WP-10 | 集成测试与回放工具 | A | 1000 tick 验证、重放一致性、隔离验证 | WP-09 |
| WP-11 | 传播增强与叙事节奏控制 | B | pending_events、传闻时延、戏剧能量池 | WP-10 |
| WP-12 | 质量度量与运营可观测性 | B | 指标体系、审计查询、异常定位能力 | WP-10, WP-11 |

## 4. 工作包详细说明

### WP-01 项目基线与配置体系（阶段A）
**范围**
- 建立目录结构、`pyproject.toml`、`config/default.yaml`。
- 建立 `config.py`（YAML + Pydantic 校验 + 环境变量替换）。

**交付物**
- 项目脚手架可启动。
- 配置模型与加载逻辑可被其他模块复用。

**验收标准**
- 配置缺失/类型错误时显式报错。
- 可通过单元测试验证配置加载与校验行为。

---

### WP-02 领域模型与契约定义（阶段A）
**范围**
- `models/` 下 Character、Event、WorldState、Action、ActionResult。
- 枚举：StateMode、Granularity、Verdict 等。
- Intent 结构化协议与动作白名单 Schema。

**交付物**
- 统一数据模型与跨层输入输出契约。

**验收标准**
- 非法字段、非法枚举值可被模型校验拦截。
- 各层模块可直接基于模型进行开发，无二义性字段定义。

---

### WP-03 Simulation Core 确定性内核（阶段A）
**范围**
- `GlobalClock`（tick 单调推进与映射）。
- `RuleEngine`（规则注册、优先级执行、结果合并）。
- `InterruptManager`（长任务中断检测）。
- `SeedManager`（全局 RNG 与子种子分配）。

**交付物**
- 可独立运行的确定性结算核心。

**验收标准**
- 固定 seed + 固定输入时，结算结果一致。
- 规则执行顺序稳定、可审计。

---

### WP-04 持久化与可恢复能力（阶段A）
**范围**
- SQLite 初始化与迁移脚本。
- Repository 封装（world snapshots、events、facts、beliefs、action_log）。
- checkpoint 存档与恢复机制。

**交付物**
- 基础数据库与读写接口。
- 重放所需的状态、种子、日志链路。

**验收标准**
- 任意 checkpoint 可恢复并继续推进。
- 行动日志包含裁定、重试、fallback 关键字段。

---

### WP-05 物候系统（硬约束）（阶段A）
**范围**
- 物候日历（季节/气候/节庆）。
- 初始三条硬约束（严冬行军惩罚、雨季疾病提升、歉收降粮）。
- 规则注册表（可扩展）。

**交付物**
- 可将物候转换为可量化状态修正的模块。

**验收标准**
- 每次物候更新至少影响一个数值状态字段。
- 修正结果进入后续结算而非仅写入文案。

---

### WP-06 LLM 抽象与多 Provider 路由（阶段A）
**范围**
- `LLMProvider` 抽象接口与健康检查。
- OpenAI/Anthropic/Ollama Provider 实现。
- Provider Router 与结构化输出 Schema。

**交付物**
- 可替换、可扩展的 LLM 调用层。

**验收标准**
- 统一接口可切换 Provider，不影响上层业务代码。
- 结构化响应校验失败时显式返回错误。

---

### WP-07 Knowledge & Diffusion 基础层（阶段A）
**范围**
- `FactStore`（客观事实）、`BeliefStore`（角色主观认知）。
- 可见性过滤：角色上下文只包含授权事实与可推断线索。
- 基础传播机制（为阶段B时延与传闻扩展预留接口）。

**交付物**
- 数据层信息隔离能力。

**验收标准**
- 信息泄露测试通过（角色无法读取未授权事实）。
- 角色上下文构建可复现、可审计。

---

### WP-08 Agent 层（意图/DM/重试）（阶段A）
**范围**
- CharacterAgent：生成 `intent + flavor_text`。
- Intent 校验器：白名单与参数合法性检查。
- DM Agent：无状态单次结算输出结构化结果。
- `REJECTED -> 重试 -> fallback` 链路。

**交付物**
- 角色行动生成与裁定后执行能力。

**验收标准**
- 非法动作拦截率 100%。
- 拒绝原因、重试次数、fallback 标记完整入库。

---

### WP-09 Orchestrator 主循环组装层（阶段A）
**范围**
- NarratorController 主循环。
- 粒度决策（年/月/日/即时）与理由落库。
- 聚光灯分层（ACTIVE/PASSIVE/DORMANT）。
- 事件池生成与跨层调用编排。

**交付物**
- “叙述者-角色-世界状态”闭环主流程。

**验收标准**
- 仅 ACTIVE 角色触发 LLM。
- 全流程满足“先裁定、后结算、再落库”顺序。

---

### WP-10 集成测试与回放工具（阶段A）
**范围**
- 集成测试：主循环、信息隔离、重放一致性。
- `scripts/replay.py` 与状态差异对比工具。

**交付物**
- 阶段A验收测试套件与调试工具链。

**验收标准**
- 1000 tick 无时间线撕裂。
- 固定 seed 回放关键状态一致。
- 平均每 tick LLM 调用数 < 总角色数 40%。

---

### WP-11 传播增强与叙事节奏控制（阶段B）
**范围**
- `pending_events` 队列与传播衰减。
- 传闻系统与时延传播。
- 戏剧能量池与节奏调度。

**交付物**
- 隔离 + 传播 + 节奏协同能力。

**验收标准**
- 休眠角色唤醒时信息注入长度可控（目标 < 300 tokens）。
- 主线连续性评分稳定。

---

### WP-12 质量度量与运营可观测性（阶段B）
**范围**
- 指标看板：角色高光覆盖率、事件闭环率、fallback 比例等。
- 审计查询模板与异常排查流程。

**交付物**
- 可运营的质量基线与问题定位路径。

**验收标准**
- 关键指标可追踪到 tick/角色/事件粒度。
- 异常结算可在日志链路中定位到根因。

## 5. 执行顺序建议
1. 严格串行：WP-01 -> WP-02 -> WP-03。
2. 可并行：WP-04、WP-05、WP-06（在 WP-03 基础上分线推进）。
3. 之后串并结合：WP-07 -> WP-08 -> WP-09 -> WP-10。
4. 阶段A验收通过后进入 WP-11、WP-12。
