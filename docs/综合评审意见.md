# 故事叙述者项目综合评审意见（整合版）

## 1. 结论摘要

当前方案方向正确，核心架构（`Narrator` 中央导演 + 多角色代理 + 物候约束）具备可落地性。  
两份外部评审与现有方案的共识是：**必须把“叙事生成”和“世界结算”彻底分离**，并通过统一时间基线、影响传播与严格动作协议，解决一致性和成本问题。

建议将方案收敛为：

1. **统一底层时间**：引入 `Global Tick`（例如 1 tick = 1 小时），叙事粒度仅是 LLM 调用封装。
2. **三态角色执行**：`ACTIVE`（调用 LLM）、`PASSIVE`（规则更新）、`DORMANT`（仅时间推进）。
3. **事件驱动聚光灯**：由“影响圈层 + 权重”选角，不使用纯随机“灵感一闪”。
4. **硬规则结算**：LLM 只给意图和文案，规则引擎负责状态更新与合法性校验。
5. **信息传播系统**：从“隔离”升级到“隔离 + 传播延迟 + 传闻机制”。

---

## 2. 三方评审的核心共识（你 + 优化意见1 + 优化意见2）

1. `Narrator` 必须是唯一权威调度者（时间、信息、仲裁、存档）。
2. 不能让所有角色每轮都调用 LLM，成本与噪声都会失控。
3. 信息隔离必须做成数据层硬隔离，不能只靠 Prompt 口头约束。
4. 物候必须成为“系统因果引擎”，而不只是背景描写。
5. 需要控制“片段精彩但主线松散”的风险（叙事张力管理）。

---

## 3. 关键风险与修正方案（按优先级）

## P0：必须先解决

1. **时间线撕裂风险**
   - 问题：不同角色使用不同粒度时容易不同步。
   - 修正：采用 `Global Tick`。长任务挂载为 `remaining_ticks`，可被事件中断（Interrupt）。

2. **逻辑瞬移/随机穿模**
   - 问题：纯概率“灵感一闪”会破坏地理与因果。
   - 修正：聚光灯选择基于影响拓扑（地点距离、关系距离、事件波及范围），随机只做微扰。

3. **LLM 幻觉直接污染状态**
   - 问题：角色直接输出自由文本动作不可结算、不可校验。
   - 修正：强制结构化输出（`intent` + `flavor_text`），并用动作白名单和参数校验器拦截非法意图。

4. **物候弱化为装饰**
   - 问题：只写进 Prompt 会被忽略。
   - 修正：物候先进入数值层（资源/疾病/迁徙/冲突概率），再驱动叙事事件池。

## P1：应尽快补齐

1. **休眠角色被动影响不足**
   - 方案：引入 `pending_events` 队列 + 影响传播衰减；唤醒时按优先级注入，不做冗长全文摘要。

2. **信息隔离过“机械”**
   - 方案：加入传闻系统、时延传播、可解释推理渠道（角色可猜测但需依据）。

3. **故事整体节奏漂移**
   - 方案：增加“叙述者意图层/戏剧能量池”，平淡积累、冲突释放。

4. **可调试性不足**
   - 方案：所有随机过程使用 `seed`；保证同一存档可重放。

## P2：中期增强

1. 元叙事监控（重复模式、角色高光覆盖率、死亡率控制）。
2. 长周期物候（多年气候趋势、节庆与文化周期）。

---

## 4. 推荐架构（收敛版）

1. **Simulation Core（确定性）**
   - `Global Tick`
   - 规则结算器（移动、战斗、资源、状态效果）
   - 中断管理器（Interrupt）
   - 存档与重放

2. **Narrative Orchestrator（半确定性）**
   - 粒度决策（年/月/日/即时）
   - 聚光灯选角（Active/Passive/Dormant）
   - 事件池生成（读取物候与世界 Tag）

3. **Agent LLM Layer（非确定性）**
   - 只负责：角色意图 + 对话/文案
   - 不负责：真实状态变更

4. **Knowledge & Diffusion Layer**
   - `Objective Facts`（客观事实）
   - `Subjective Beliefs`（角色认知）
   - 传播图与延迟机制

---

## 5. 关键数据结构建议

```json
{
  "role_id": "char_001",
  "state_mode": "ACTIVE|PASSIVE|DORMANT",
  "location_id": "loc_xuchang",
  "long_action": {"type": "SECLUSION", "remaining_ticks": 720},
  "knowledge_set": ["fact_001", "fact_003"],
  "pending_events": [{"event_id": "evt_045", "priority": 0.9, "ttl": 48}],
  "status_effects": [{"type": "injured", "severity": 0.3, "remain": 5}],
  "narrative_importance": 0.8,
  "last_active_tick": 1250
}
```

```json
{
  "event_id": "evt_1002",
  "tags": ["conspiracy", "palace"],
  "impact_scope": {
    "locations": ["loc_palace"],
    "factions": ["f_court"],
    "radius": 2
  },
  "hard_effects": [{"target": "food_stock", "delta": -0.5}],
  "soft_prompts": ["rainy season, morale down"]
}
```

---

## 6. 角色筛选（聚光灯）建议公式

`activation_score = w1*geo + w2*relation + w3*availability + w4*narrative_importance + w5*random_noise`

推荐策略：

1. `score >= T_active` -> `ACTIVE`
2. `T_passive <= score < T_active` -> `PASSIVE`
3. `< T_passive` -> `DORMANT`
4. 若事件命中“强约束”（同地点受灾、被袭击目标），强制 `ACTIVE` 或 `PASSIVE`，忽略随机项

---

## 7. 主循环（落地流程）

1. 推进一个 `Global Tick`。
2. 更新物候与全局状态（确定性）。
3. 处理长程任务 `remaining_ticks--`，并检测中断条件。
4. 生成/刷新事件池，计算影响传播。
5. 角色分层（Active/Passive/Dormant）。
6. 仅对 `ACTIVE` 调用 LLM（结构化输出），再由规则引擎结算。
7. 写入日志与 checkpoint；按策略决定是否切换叙事粒度。

---

## 8. 里程碑与验收指标

## 阶段A（先做，2-3周）

目标：跑通“无玩家”最小闭环。

1. 固定 2-3 角色，`Global Tick` + 三态执行。
2. 动作白名单与 JSON 校验器。
3. 物候硬约束至少 3 条（如严冬行军惩罚、雨季疾病提升、歉收降粮）。

验收：

1. 1000 tick 无时间线撕裂。
2. 非法动作拦截率 100%。
3. 平均每 tick LLM 调用数 < 总角色数的 40%。

## 阶段B（随后，2-4周）

目标：引入传播与叙事节奏控制。

1. 影响传播图 + `pending_events` 队列。
2. 传闻与时延传播。
3. 戏剧能量池。

验收：

1. 休眠角色唤醒后信息注入长度可控（例如 < 300 tokens）。
2. 主线事件连续性评分稳定（可用人工标注 + 简单规则评分）。
3. 可重放一致率达标（固定 seed 下关键状态一致）。

---

## 9. 最终建议（执行层）

1. 先不要扩展角色数量，先把“时间统一 + 规则结算 + 聚光灯分层”做稳。
2. 把“即时模式”硬性限制在 1-3 轮，超限自动结算回到“日”粒度。
3. 任何会改变世界状态的内容都必须经过规则引擎，不允许 LLM 直写数据库。
4. 优先建设调试工具：事件回放、状态差异对比、seed 重跑。

如果按这个收敛版推进，你的系统会同时满足三件事：  
**可控成本、强一致性、可持续扩展**。
